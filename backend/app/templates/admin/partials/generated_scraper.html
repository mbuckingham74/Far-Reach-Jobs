<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 transition-colors">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold dark:text-white flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
            </svg>
            Generated Custom Scraper
        </h3>
        {% if result.success %}
        <span class="px-3 py-1 text-sm font-medium rounded-full bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300">
            Code Generated
        </span>
        {% else %}
        <span class="px-3 py-1 text-sm font-medium rounded-full bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300">
            Generation Failed
        </span>
        {% endif %}
    </div>

    {% if result.error %}
    <div class="bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-200 border border-red-200 dark:border-red-800 rounded-md p-3 mb-4">
        <strong>Error:</strong> {{ result.error }}
    </div>
    {% endif %}

    {% if result.success %}
    <div class="bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-200 border border-green-200 dark:border-green-800 rounded-md p-3 mb-4">
        <p class="font-medium">Custom scraper is ready to run!</p>
        <p class="text-sm mt-1">Class name: <code class="bg-green-100 dark:bg-green-800 px-1 rounded">{{ result.class_name }}</code></p>
        <p class="text-sm mt-1">The source is now configured to use this custom scraper code.</p>
    </div>

    <!-- Scrape Now Button -->
    <div class="mb-4">
        <button type="button"
                hx-post="/admin/sources/{{ source.id }}/scrape"
                hx-target="#scrape-modal-result"
                hx-swap="innerHTML"
                onclick="showScrapeModal({{ source.name|tojson }}, {{ 'true' if source.use_playwright or source.use_playwright is none else 'false' }})"
                class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Run Custom Scraper Now
        </button>
    </div>

    <details class="mb-4">
        <summary class="cursor-pointer font-medium text-gray-900 dark:text-white flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
            </svg>
            View Generated Code
        </summary>
        <div class="mt-3">
            <div class="flex items-center justify-end mb-2">
                <button type="button" onclick="copyScraperCode(this)"
                        class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Copy
                </button>
            </div>
            <pre id="scraper-code" class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto text-sm font-mono max-h-96 overflow-y-auto"><code>{{ result.code }}</code></pre>
        </div>
    </details>

    <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-md p-4">
        <h4 class="font-medium text-blue-800 dark:text-blue-200 mb-2">How It Works:</h4>
        <ul class="text-sm text-blue-700 dark:text-blue-300 list-disc list-inside space-y-1">
            <li>The custom scraper code is saved to this source's configuration</li>
            <li>When you run the scraper, the code executes dynamically</li>
            <li>No manual file creation needed - it's fully automated</li>
            <li>The scraper will also run on the daily schedule</li>
        </ul>
    </div>

    <script>
        // Sync the scraper type dropdown to Dynamic since we just generated custom code
        (function() {
            const scraperSelect = document.getElementById('scraper_class');
            if (scraperSelect) {
                scraperSelect.value = 'DynamicScraper';
            }
        })();

        function copyScraperCode(btn) {
            const code = document.getElementById('scraper-code').textContent;
            const originalHTML = btn.innerHTML;

            navigator.clipboard.writeText(code).then(() => {
                btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Copied!';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                }, 2000);
            }).catch((err) => {
                console.error('Clipboard write failed:', err);
                btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> Failed';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                }, 2000);
            });
        }
    </script>
    {% endif %}
</div>
