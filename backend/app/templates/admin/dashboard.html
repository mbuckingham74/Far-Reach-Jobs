{% extends "base.html" %}

{% block title %}Admin Dashboard - Far Reach Jobs{% endblock %}

{% block content %}
<!-- Scrape Progress Modal -->
<div id="scrape-modal" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="closeScrapeModal()"></div>
    <!-- Modal content -->
    <div class="fixed inset-0 flex items-center justify-center p-4 pointer-events-none">
        <div id="scrape-modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6 pointer-events-auto">
            <!-- Initial loading state -->
            <div id="scrape-modal-loading" class="text-center py-4">
                <div class="inline-block w-12 h-12 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mb-4"></div>
                <h3 id="scrape-modal-title" class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Running Scrape...</h3>
                <p id="scrape-modal-source" class="text-gray-600 dark:text-gray-400 text-sm"></p>
            </div>
            <!-- Result will be swapped here -->
            <div id="scrape-modal-result"></div>
        </div>
    </div>
</div>

<div class="mb-6 flex justify-between items-center">
    <div>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Admin Dashboard</h2>
        <p class="text-gray-600 dark:text-gray-300">Manage scrape sources and monitor job data</p>
    </div>
    <div class="flex gap-2">
        <a href="/admin/scraper-guide" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white font-medium rounded-md transition-colors">
            Scraper Guide
        </a>
        <a href="/admin/history" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-md transition-colors">
            Scrape History
        </a>
        <form method="post" action="/admin/logout">
            <button type="submit" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white font-medium rounded-md transition-colors">
                Logout
            </button>
        </form>
    </div>
</div>

<!-- Stats -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 transition-colors">
        <div class="text-3xl font-bold text-primary-600">{{ sources|length }}</div>
        <div class="text-gray-600 dark:text-gray-400">Scrape Sources</div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 transition-colors">
        <div class="text-3xl font-bold text-green-600 dark:text-green-500">{{ job_count }}</div>
        <div class="text-gray-600 dark:text-gray-400">Active Jobs</div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 transition-colors">
        <div class="text-3xl font-bold text-amber-600 dark:text-amber-500">{{ stale_count }}</div>
        <div class="text-gray-600 dark:text-gray-400">Stale Jobs</div>
    </div>
</div>

<!-- Manual Scrape -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8 transition-colors">
    <h3 class="text-lg font-semibold dark:text-white mb-4">Manual Scrape</h3>
    <button
        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md transition-colors inline-flex items-center justify-center"
        hx-post="/admin/scrape"
        hx-target="#scrape-modal-result"
        hx-swap="innerHTML show:none"
        onclick="openScrapeModal()">
        Run Scraper Now
    </button>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
        Scheduled scrapes run at noon and midnight Alaska time.
    </p>
</div>

<!-- Add Source Form -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8 transition-colors">
    <h3 class="text-lg font-semibold dark:text-white mb-4">Add Scrape Source</h3>
    <form id="add-source-form" hx-post="/admin/sources" hx-target="#source-list" hx-swap="innerHTML show:none" class="space-y-4">
    <script>
        document.body.addEventListener('sourceCreated', function() {
            document.getElementById('add-source-form').reset();
        });
    </script>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Source Name</label>
                <input type="text" id="name" name="name" required placeholder="e.g., City of Bethel"
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 dark:text-white dark:placeholder-gray-400">
            </div>
            <div>
                <label for="base_url" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jobs Page URL</label>
                <input type="url" id="base_url" name="base_url" required placeholder="https://example.com/jobs"
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 dark:text-white dark:placeholder-gray-400">
            </div>
        </div>
        <div>
            <label for="scraper_class" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Scraper Type</label>
            <select id="scraper_class" name="scraper_class"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 dark:text-white">
                <option value="GenericScraper" selected>Generic (configure CSS selectors)</option>
                <option value="SitemapScraper">Sitemap (XML URL parsing)</option>
            </select>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">After adding, click "Configure" to set up scraper settings.</p>
        </div>
        <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition-colors">
            Add Source
        </button>
    </form>
</div>

<!-- Bulk Import CSV -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8 transition-colors">
    <h3 class="text-lg font-semibold dark:text-white mb-4">Bulk Import from CSV</h3>
    <form id="csv-import-form" hx-post="/admin/sources/import-csv" hx-target="#csv-import-result-container" hx-swap="innerHTML" hx-encoding="multipart/form-data" class="space-y-4">
        <div>
            <label for="csv-file" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CSV File</label>
            <input type="file" id="csv-file" name="file" accept=".csv" required
                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 dark:text-white file:mr-4 file:py-1 file:px-3 file:rounded file:border-0 file:text-sm file:font-medium file:bg-primary-50 file:text-primary-700 dark:file:bg-primary-900 dark:file:text-primary-300 hover:file:bg-primary-100 dark:hover:file:bg-primary-800">
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Required columns: <span class="font-mono text-xs">Source Name</span>, <span class="font-mono text-xs">Base URL</span>. Optional: <span class="font-mono text-xs">Jobs URL</span>.
                <a href="/admin/sources/needs-configuration" class="text-amber-600 dark:text-amber-400 hover:underline">Imported sources need configuration before enabling.</a>
            </p>
        </div>
        <div class="flex items-center gap-4">
            <button type="submit" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-md transition-colors inline-flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                </svg>
                Import Sources
            </button>
            <a href="#" onclick="toggleCsvHelp(); return false;" class="text-sm text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300">
                View CSV format example
            </a>
        </div>
    </form>

    <!-- CSV Format Help (hidden by default) -->
    <div id="csv-help" class="hidden mt-4 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
        <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Example CSV format:</p>
        <pre class="text-xs bg-gray-100 dark:bg-gray-800 p-3 rounded overflow-x-auto"><code>Source Name,Base URL,Jobs URL
City of Bethel,https://www.cityofbethel.net,https://www.cityofbethel.net/jobs
NANA Regional,https://nana.com,https://nana.com/careers
Yukon-Kuskokwim Health,https://www.ykhc.org,https://www.ykhc.org/employment</code></pre>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
            Notes: Column headers are flexible (e.g., "Name" or "Organization" also work). Jobs URL is optional - if omitted, Base URL will be used.
        </p>
    </div>

    <!-- Import result will appear here -->
    <div id="csv-import-result-container"></div>
</div>

<!-- Source List -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 transition-colors">
    <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-3">
            <h3 class="text-lg font-semibold dark:text-white">Active Sources</h3>
            <a href="/admin/sources/export-active" class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 rounded transition-colors inline-flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Export CSV
            </a>
        </div>
        <div class="flex gap-4">
            <div id="needs-configuration-count-link" hx-get="/admin/sources/needs-configuration-count" hx-trigger="load, refreshSourceList from:body" hx-swap="innerHTML show:none">
                {% if needs_configuration_count > 0 %}
                <a href="/admin/sources/needs-configuration" class="text-sm text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300 transition-colors font-medium">
                    Needs Configuration ({{ needs_configuration_count }})
                </a>
                {% endif %}
            </div>
            <div id="robots-blocked-count-link" hx-get="/admin/sources/robots-blocked-count" hx-trigger="load, refreshSourceList from:body" hx-swap="innerHTML show:none">
                {% if robots_blocked_count > 0 %}
                <a href="/admin/sources/robots-blocked" class="text-sm text-amber-600 dark:text-amber-400 hover:text-amber-700 dark:hover:text-amber-300 transition-colors">
                    Robots.txt Blocked ({{ robots_blocked_count }})
                </a>
                {% endif %}
            </div>
            <div id="disabled-count-link" hx-get="/admin/sources/disabled-count" hx-trigger="load, refreshSourceList from:body" hx-swap="innerHTML show:none">
                {% if disabled_count > 0 %}
                <a href="/admin/sources/disabled" class="text-sm text-gray-500 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors">
                    Disabled ({{ disabled_count }})
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    <div id="source-list" hx-get="/admin/sources" hx-trigger="load, refreshSourceList from:body" hx-swap="innerHTML show:none">
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">Loading sources...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleCsvHelp() {
        const help = document.getElementById('csv-help');
        help.classList.toggle('hidden');
    }

    function openScrapeModal(sourceName) {
        const modal = document.getElementById('scrape-modal');
        const loading = document.getElementById('scrape-modal-loading');
        const result = document.getElementById('scrape-modal-result');
        const sourceText = document.getElementById('scrape-modal-source');
        const titleText = document.getElementById('scrape-modal-title');

        // Reset modal state
        loading.classList.remove('hidden');
        result.innerHTML = '';
        titleText.textContent = 'Running Scrape...';
        sourceText.textContent = sourceName ? `Scraping: ${sourceName}` : 'Scraping all active sources...';

        // Show modal
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeScrapeModal() {
        const modal = document.getElementById('scrape-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }

    function onScrapeComplete() {
        const loading = document.getElementById('scrape-modal-loading');
        loading.classList.add('hidden');
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeScrapeModal();
        }
    });

    // Handle dashboard scrape button clicks via event delegation (avoids quoting issues)
    document.body.addEventListener('click', function(event) {
        const btn = event.target.closest('.dashboard-scrape-btn');
        if (btn) {
            const sourceName = btn.dataset.sourceName;
            openScrapeModal(sourceName);
        }
    });

    // Listen for HTMX after swap to hide loading spinner
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'scrape-modal-result') {
            onScrapeComplete();
        }
    });
</script>
{% endblock %}
