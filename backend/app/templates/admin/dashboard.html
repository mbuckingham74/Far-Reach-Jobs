{% extends "base.html" %}

{% block title %}Admin Dashboard - Far Reach Jobs{% endblock %}

{% block content %}
<!-- Scrape Progress Modal -->
<div id="scrape-modal" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="closeScrapeModal()"></div>
    <!-- Modal content -->
    <div class="fixed inset-0 flex items-center justify-center p-4 pointer-events-none">
        <div id="scrape-modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6 pointer-events-auto">
            <!-- Initial loading state -->
            <div id="scrape-modal-loading" class="text-center py-4">
                <div class="inline-block w-12 h-12 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mb-4"></div>
                <h3 id="scrape-modal-title" class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Running Scrape...</h3>
                <p id="scrape-modal-source" class="text-gray-600 dark:text-gray-400 text-sm"></p>
            </div>
            <!-- Result will be swapped here -->
            <div id="scrape-modal-result"></div>
        </div>
    </div>
</div>

<div class="mb-6 flex justify-between items-center">
    <div>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Admin Dashboard</h2>
        <p class="text-gray-600 dark:text-gray-300">Manage scrape sources and monitor job data</p>
    </div>
    <div class="flex gap-2">
        <a href="/admin/history" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-md transition-colors">
            Scrape History
        </a>
        <form method="post" action="/admin/logout">
            <button type="submit" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white font-medium rounded-md transition-colors">
                Logout
            </button>
        </form>
    </div>
</div>

<!-- Stats -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 transition-colors">
        <div class="text-3xl font-bold text-primary-600">{{ sources|length }}</div>
        <div class="text-gray-600 dark:text-gray-400">Scrape Sources</div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 transition-colors">
        <div class="text-3xl font-bold text-green-600 dark:text-green-500">{{ job_count }}</div>
        <div class="text-gray-600 dark:text-gray-400">Active Jobs</div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 transition-colors">
        <div class="text-3xl font-bold text-amber-600 dark:text-amber-500">{{ stale_count }}</div>
        <div class="text-gray-600 dark:text-gray-400">Stale Jobs</div>
    </div>
</div>

<!-- Manual Scrape -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8 transition-colors">
    <h3 class="text-lg font-semibold dark:text-white mb-4">Manual Scrape</h3>
    <button
        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md transition-colors inline-flex items-center justify-center"
        hx-post="/admin/scrape"
        hx-target="#scrape-modal-result"
        hx-swap="innerHTML"
        onclick="openScrapeModal()">
        Run Scraper Now
    </button>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
        Scheduled scrapes run at noon and midnight Alaska time.
    </p>
</div>

<!-- Add Source Form -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8 transition-colors">
    <h3 class="text-lg font-semibold dark:text-white mb-4">Add Scrape Source</h3>
    <form id="add-source-form" hx-post="/admin/sources" hx-target="#source-list" hx-swap="innerHTML" class="space-y-4">
    <script>
        document.body.addEventListener('sourceCreated', function() {
            document.getElementById('add-source-form').reset();
        });
    </script>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Source Name</label>
                <input type="text" id="name" name="name" required placeholder="e.g., City of Bethel"
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 dark:text-white dark:placeholder-gray-400">
            </div>
            <div>
                <label for="base_url" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jobs Page URL</label>
                <input type="url" id="base_url" name="base_url" required placeholder="https://example.com/jobs"
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 dark:text-white dark:placeholder-gray-400">
            </div>
        </div>
        <div>
            <label for="scraper_class" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Scraper Type</label>
            <select id="scraper_class" name="scraper_class"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 dark:text-white">
                <option value="GenericScraper" selected>Generic (configure CSS selectors)</option>
            </select>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">After adding, click "Configure" to set up CSS selectors for scraping.</p>
        </div>
        <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition-colors">
            Add Source
        </button>
    </form>
</div>

<!-- Source List -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 transition-colors">
    <h3 class="text-lg font-semibold dark:text-white mb-4">Scrape Sources</h3>
    <div id="source-list" hx-get="/admin/sources" hx-trigger="load">
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">Loading sources...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openScrapeModal(sourceName) {
        const modal = document.getElementById('scrape-modal');
        const loading = document.getElementById('scrape-modal-loading');
        const result = document.getElementById('scrape-modal-result');
        const sourceText = document.getElementById('scrape-modal-source');
        const titleText = document.getElementById('scrape-modal-title');

        // Reset modal state
        loading.classList.remove('hidden');
        result.innerHTML = '';
        titleText.textContent = 'Running Scrape...';
        sourceText.textContent = sourceName ? `Scraping: ${sourceName}` : 'Scraping all active sources...';

        // Show modal
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeScrapeModal() {
        const modal = document.getElementById('scrape-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }

    function onScrapeComplete() {
        const loading = document.getElementById('scrape-modal-loading');
        loading.classList.add('hidden');
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeScrapeModal();
        }
    });

    // Listen for HTMX after swap to hide loading spinner
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'scrape-modal-result') {
            onScrapeComplete();
        }
    });
</script>
{% endblock %}
